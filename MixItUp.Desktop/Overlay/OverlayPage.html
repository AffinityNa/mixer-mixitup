<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta charset="utf-8" />
        <title>Mix It Up - Overlay</title>
        <link rel="shortcut icon" type="image/x-icon" href="https://github.com/SaviorXTanren/mixer-mixitup/raw/master/Wiki/Images/LogoSmall.png" />
        <link rel="stylesheet" type="text/css" href="animate.min.css">

        <script src="jquery.min.js"></script>

        <script src="webSocketWrapper.js"></script>

        <script src="http://code.responsivevoice.org/responsivevoice.js"></script>
    </head>
    <body style="background-color: transparent; overflow: hidden; position: absolute; width: 100%; max-width: 100%; min-width: 100%; height: 100%; max-height: 100%; min-height: 100%; margin: 0px;">
        <div id="mainOverlay" style="position: absolute; width: 100%; max-width: 100%; min-width: 100%; height: 100%; max-height: 100%; min-height: 100%; margin: 0px;"></div>

        <div id="noConnectionDiv" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); visibility: hidden">
            <h1 style="font-size: 100px; color: red; text-align: center">No Connection To</h1>
            <h1 style="font-size: 100px; color: red; text-align: center">Mix It Up Overlay!</h1>
        </div>

        <div id="noTextToSpeechDiv" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); visibility: hidden">
            <h1 style="font-size: 100px; color: red; text-align: center">This Browser Does</h1>
            <h1 style="font-size: 100px; color: red; text-align: center">Not Support Text</h1>
            <h1 style="font-size: 100px; color: red; text-align: center">To Speech!</h1>
        </div>

        <div id="youtubeSongRequestPlayerDiv" style="position: relative; left: -2000px"></div>

        <div id="youtubeVideoPlayerDiv" style="position: relative; left: -2000px"></div>

        <script>
            $.fn.extend({
                animateCss: function (animationName, callback) {
                    var animationEnd = (function (el) {
                        var animations = {
                            animation: 'animationend',
                            OAnimation: 'oAnimationEnd',
                            MozAnimation: 'mozAnimationEnd',
                            WebkitAnimation: 'webkitAnimationEnd',
                        };

                        for (var t in animations) {
                            if (el.style[t] !== undefined) {
                                return animations[t];
                            }
                        }
                    })(document.createElement('div'));

                    if (animationName) {
                        this.addClass('animated ' + animationName).one(animationEnd, function () {
                            $(this).removeClass('animated ' + animationName);

                            if (typeof callback === 'function') callback();
                        });
                    }
                    else if (typeof callback === 'function') callback();

                    return this;
                },
            });

            var itemDictionary = {};

            var zIndexCounter = 0;

            var mainOverlayDiv = document.getElementById('mainOverlay');
            var noConnectionDiv = document.getElementById('noConnectionDiv');
            var noTextToSpeechDiv = document.getElementById('noTextToSpeechDiv');

            // YouTube player

            var youtubeIFrameAPIReady = false;

            var youtubeSongRequestPlayerDiv = document.getElementById('youtubeSongRequestPlayerDiv');
            var youtubeSongRequestPlayer;
            var youtubeSongRequestPlayerReady = false;
            var youtubeSongRequestPlaying = false;

            var youtubeVideoPlayerDiv = document.getElementById('youtubeVideoPlayerDiv');
            var youtubeVideoPlayer;

            var youtubePlayerScript = document.createElement('script');
            youtubePlayerScript.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(youtubePlayerScript, firstScriptTag);

            function connectionOpened() {
                noConnectionDiv.style.visibility = 'hidden';
            }

            function connectionClosed() {
                noConnectionDiv.style.visibility = 'visible';
            }

            function packetReceived(packet) {
                try {
                    if (packet != null && typeof packet.type !== 'undefined') {
                        if (packet.type === "test") {
                            testPacket();
                        }
                        else if (packet.type === "remove") {
                            removePacket(packet.data);
                        }
                        else if (packet.type === "image") {
                            imagePacket(packet.data);
                        }
                        else if (packet.type === "text") {
                            textPacket(packet.data);
                        }
                        else if (packet.type === "youtube") {
                            youtubePacket(packet.data);
                        }
                        else if (packet.type === "video") {
                            videoPacket(packet.data);
                        }
                        else if (packet.type === "htmlText") {
                            htmlTextPacket(packet.data);
                        }
                        else if (packet.type === "webPage") {
                            webPagePacket(packet.data);
                        }
                        else if (packet.type === "textToSpeech") {
                            textToSpeechPacket(packet.data);
                        }
                        else if (packet.type === "songRequest") {
                            songRequestPacket(packet.data);
                        }
                        else if (packet.type === "custom") {
                            customPacket(packet.data);
                        }
                        else if (packet.type == "batch") {
                            for (var i = 0; i < packet.array.length; i++) {
                                packetReceived(packet.array[i]);
                            }
                        }
                    }
                }
                catch (err) { logException(err); }
            }

            function testPacket() {
                var data = {
                    Text: 'Connection Test!', Size: 100, Color: 'red', EntranceAnimationName: 'fadeIn', VisibleAnimationName: '', ExitAnimationName: 'fadeOut',
                    Horizontal: 50, Vertical: 50, Duration: 3, IsPercentagePosition: true
                };
                textPacket(data);
            }

            function removePacket(data) {
                if (itemDictionary[data.ID]) {
                    mainOverlayDiv.removeChild(itemDictionary[data.ID]);
                    itemDictionary[data.ID] = null;
                }
            }

            function imagePacket(data) {
                var addedElement = document.createElement('img');
                addedElement.src = data.FullLink;
                addedElement.style.cssText += 'width: ' + data.Width + 'px; height: ' + data.Height + 'px; ';

                addWaitRemoveElement(data, addedElement);
            }

            function textPacket(data) {
                var addedElement = document.createElement('p');
                addedElement.innerHTML = data.Text;
                addedElement.style.cssText += 'font-size: ' + data.Size + 'px; color: ' + data.Color + '; ' + ' white-space: nowrap;';
                if (data.Font) {
                    addedElement.style.cssText += 'font-family: \"' + data.Font + '\";';
                }
                if (data.Bold) {
                    addedElement.style.cssText += 'font-weight: bold;';
                }
                if (data.Underline) {
                    addedElement.style.cssText += 'text-decoration: underline;';
                }
                if (data.Italic) {
                    addedElement.style.cssText += 'font-style: italic;';
                }
                if (data.ShadowColor) {
                    addedElement.style.cssText += 'text-shadow: -1px 0 ' + data.ShadowColor + ', 0 1px ' + data.ShadowColor + ', 1px 0 ' + data.ShadowColor + ', 0 -1px ' + data.ShadowColor + ';';
                }

                addWaitRemoveElement(data, addedElement);
            }

            function youtubePacket(data) {
                if (youtubeIFrameAPIReady) {
                    var addedElement = document.createElement('div');
                    addedElement.id = 'youtubeVideo' + data.ID;

                    addWaitRemoveElement(data, addedElement);

                    var youtubeVideoPlayer = new YT.Player(addedElement.id, {
                        height: data.Height,
                        width: data.Width,
                        videoId: data.ID,
                        playerVars: { 'autoplay': 1, 'controls': 0, 'modestbranding': 1, 'start': data.StartTime },
                        events: {
                            'onReady': function () {
                                youtubeVideoPlayer.setVolume(data.Volume);
                                youtubeVideoPlayer.setLoop(false);
                                youtubeVideoPlayer.frameBorder = 0;
                            }
                        }
                    });
                }
            }

            function videoPacket(data) {
                var addedElement = document.createElement('video');
                addedElement.width = data.Width;
                addedElement.height = data.Height;
                addedElement.frameBorder = 0;
                addedElement.allow = "autoplay; encrypted-media";
                addedElement.setAttribute('autoplay', '');
                addedElement.volume = data.VolumeDecimal;

                sourceElement = document.createElement('source');
                sourceElement.src = data.FullLink;
                if (data.FilePath.endsWith(".mp4")) {
                    sourceElement.type = "video/mp4";
                }
                else if (data.FilePath.endsWith(".webm")) {
                    sourceElement.type = "video/webm";
                }
                addedElement.appendChild(sourceElement);

                addWaitRemoveElement(data, addedElement);
            }

            function htmlTextPacket(data) {
                var addedElement = document.createElement('div');
                addedElement.innerHTML = data.HTMLText;

                addWaitRemoveElement(data, addedElement);
            }

            function webPagePacket(data) {
                var addedElement = document.createElement('iframe');
                addedElement.src = data.URL;
                addedElement.width = data.Width;
                addedElement.height = data.Height;
                addedElement.frameBorder = 0;

                addWaitRemoveElement(data, addedElement);
            }

            function textToSpeechPacket(data) {
                if (responsiveVoice.voiceSupport()) {
                    responsiveVoice.speak(data.Text, data.Voice, { pitch: data.Pitch, rate: data.Rate, volume: data.Volume });
                }
                else {
                    var data = { Horizontal: 50, Vertical: 50, Duration: 3 };
                    addWaitRemoveElement(data, noTextToSpeechDiv);
                }
            }

            function songRequestPacket(data) {
                if (data.Type == 'YouTube' && youtubeSongRequestPlayerReady) {
                    if (data.Action == 'status') {
                        var data = {};
                        data.Type = 1;
                        data.State = 0;

                        var playerState = youtubeSongRequestPlayer.getPlayerState();
                        if (playerState == YT.PlayerState.PLAYING || playerState == YT.PlayerState.PAUSED || playerState == YT.PlayerState.ENDED) {
                            data.ID = youtubeSongRequestPlayer.getVideoUrl();
                            data.Progress = youtubeSongRequestPlayer.getCurrentTime();
                            data.Length = youtubeSongRequestPlayer.getDuration();
                            data.Volume = youtubeSongRequestPlayer.getVolume();

                            if (playerState == YT.PlayerState.PLAYING) {
                                data.State = 1;
                            }
                            else if (playerState == YT.PlayerState.PAUSED) {
                                data.State = 2;
                            }
                            else if (playerState == YT.PlayerState.ENDED) {
                                data.State = 3;
                            }
                        }

                        sendPacket('songRequestStatus', data);
                    }
                    else if (data.Action == 'playpause' && youtubeSongRequestPlaying) {
                        if (youtubeSongRequestPlayer.getPlayerState() == YT.PlayerState.PLAYING) {
                            youtubeSongRequestPlayer.pauseVideo();
                        }
                        else if (youtubeSongRequestPlayer.getPlayerState() == YT.PlayerState.PAUSED) {
                            youtubeSongRequestPlayer.playVideo();
                        }
                    }
                    else if (data.Action == 'stop') {
                        youtubeSongRequestPlaying = false;
                        youtubeSongRequestPlayer.stopVideo();
                    }
                    else if (data.Action == 'next') {
                        youtubeSongRequestPlayer.nextVideo();
                    }
                    else if (data.Action == 'song') {
                        youtubeSongRequestPlaying = true;
                        youtubeSongRequestPlayer.setVolume(data.Volume);
                        youtubeSongRequestPlayer.setLoop(false);
                        youtubeSongRequestPlayer.loadVideoById(data.Source);
                    }
                    else if (data.Action == 'playlist') {
                        youtubeSongRequestPlaying = true;
                        youtubeSongRequestPlayer.setVolume(data.Volume);
                        youtubeSongRequestPlayer.setLoop(true);
                        youtubeSongRequestPlayer.loadPlaylist({ list: data.Source, listType: 'playlist', index: 0 });
                        youtubeSongRequestPlayer.setShuffle(true);
                    }
                    else if (data.Action == 'volume') {
                        youtubeSongRequestPlayer.setVolume(data.Volume);
                    }
                }
            }

            function customPacket(data) {
                var addedElement = document.createElement('div');
                addedElement.innerHTML = data.HTMLText;

                addWaitRemoveElement(data, addedElement);
            }

            function addWaitRemoveElement(data, addedElement, addToDiv = true) {
                if (addedElement != null) {

                    addedElement.style.cssText += 'position: absolute;  margin: 0px;'
                    if (data.IsPixelPosition) {
                        addedElement.style.cssText += 'left: ' + data.Horizontal.toString() + 'px; top: ' + data.Vertical.toString() + 'px;'
                    }
                    else {
                        addedElement.style.cssText += 'left: ' + data.Horizontal.toString() + '%; top: ' + data.Vertical.toString() + '%; transform: translate(-50%, -50%);'
                    }

                    removePacket(data);

                    var divContainer = document.createElement('div');
                    divContainer.id = data.ID;
                    divContainer.style.cssText += 'position: absolute; width: 100%; max-width: 100%; min-width: 100%; height: 100%; max-height: 100%; min-height: 100%; margin: 0px;';
                    if (data.Duration > 0) {
                        divContainer.style.zIndex = zIndexCounter++;
                    }
                    divContainer.appendChild(addedElement);

                    itemDictionary[data.ID] = divContainer;

                    if (data.Duration > 0) {
                        $(divContainer).animateCss(data.EntranceAnimationName, function () {

                            setTimeout(function () {

                                $(divContainer).animateCss(data.VisibleAnimationName);

                                setTimeout(function () {

                                    var elementToAnimate = divContainer;
                                    if (data.ExitAnimationName && data.ExitAnimationName == 'hinge') {
                                        elementToAnimate = addedElement;
                                    }

                                    $(elementToAnimate).animateCss(data.ExitAnimationName, function () {

                                        removePacket(data);
                                    });

                                }, (data.Duration * 1000 * 2) / 3);

                            }, (data.Duration * 1000) / 3);
                        });
                    }

                    mainOverlayDiv.appendChild(divContainer);
                }
            }

            function logException(err) {
                logToSessionStorage(err);
            }

            function onYouTubeIframeAPIReady() {
                youtubeIFrameAPIReady = true;

                youtubeSongRequestPlayer = new YT.Player('youtubeSongRequestPlayerDiv', {
                    height: '390',
                    width: '640',
                    videoId: 'RvCVgu_MQpU',
                    playerVars: { 'controls': 0 },
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange
                    }
                });
            }

            function onPlayerReady(event) {
                youtubeSongRequestPlayerReady = true;
            }

            function onPlayerStateChange(event) {
                if (event.data == YT.PlayerState.ENDED && youtubeSongRequestPlaying) {
                    sendPacket('songRequestComplete', '');
                    youtubeSongRequestPlaying = false;
                }
            }

            openWebsocketConnection("0000");
        </script>
    </body>
</html>