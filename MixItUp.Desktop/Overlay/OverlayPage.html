<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta charset="utf-8" />
    </head>
    <body style="background-color:transparent">
        <div id="mainOverlay" />
		
        <div id="roluetteWheelDiv" width="421" height="564" class="the_wheel" align="center" valign="center" style="visibility:hidden">
            <canvas id="canvas" width="420" height="420">
                <p style="{color: white}" align="center">Sorry, your browser doesn't support canvas. Please try another.</p>
            </canvas>
        </div>

		<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
		<script type="text/javascript" src="wheel/Winwheel.min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script>
		
        <script src="webSocketWrapper.js"></script>

		<script>
			// Create new wheel object specifying the parameters at creation time.
            var theWheel = new Winwheel({
                'numSegments'       : 8,                 // Specify number of segments.
                'outerRadius'       : 200,               // Set outer radius so wheel fits inside the background.
                'drawText'          : false,              // Code drawn text can be used with segment images.
                'textFontSize'      : 16,
                'textOrientation'   : 'curved',
                'textAlignment'     : 'inner',
                'textMargin'        : 90,
                'textFontFamily'    : 'monospace',
                'textStrokeStyle'   : 'black',
                'textLineWidth'     : 3,
                'textFillStyle'     : 'white',
                'drawMode'          : 'segmentImage',    // Must be segmentImage to draw wheel using one image per segemnt.
                'segments'          :                    // Define segments including image and text.
                [
                   {'image' : 'wheel/lose.png',  'text' : 'Lose'},
                   {'image' : 'wheel/win.png',  'text' : 'Win'},
                   {'image' : 'wheel/lose.png',  'text' : 'Lose'},
                   {'image' : 'wheel/win.png',  'text' : 'Win'},
                   {'image' : 'wheel/lose.png',  'text' : 'Lose'},
                   {'image' : 'wheel/win.png',  'text' : 'Win'},
                   {'image' : 'wheel/lose.png',  'text' : 'Lose'},
                   {'image' : 'wheel/bonus.png',  'text' : 'Bonus'},
                ],
                'animation' :           // Specify the animation to use.
                {
                    'type'     : 'spinToStop',
                    'duration' : 5,     // Duration in seconds.
                    'spins'    : 8,     // Number of complete spins.
                    'callbackFinished': 'rouletteWheelResult()'
                }
            });
		
            var mainOverlayDiv = document.getElementById('mainOverlay');
            var roluetteWheelDiv = document.getElementById('roluetteWheelDiv');

            function connectionOpened() { }

            function connectionClosed() { }

            function packetReceived(packet)
            {
                try
                {
                    if (packet != null && typeof packet.type !== 'undefined')
                    {
                        if (packet.type === "test")
                        {
                            testPacket();
                        }
                        else if (packet.type === "image")
                        {
                            imagePacket(packet.data);
                        }
                        else if (packet.type === "text")
                        {
                            textPacket(packet.data);
                        }
                        else if (packet.type === "htmlText")
                        {
                            htmlTextPacket(packet.data);
                        }
						else if (packet.type === "rouletteWheel")
                        {
                            rouletteWheelPacket(packet.data);
                        }
                    }
                }
                catch (err) { logException(err); }
            }

            function testPacket()
            {
                var addedElement = document.createElement('h1');
                addedElement.innerHTML = 'Connection Test!';
                addedElement.style.cssText += 'font-size: 100px';

                var data = { horizontal: 50, vertical: 50, duration: 3 };

                addWaitRemoveElement(data, addedElement);
            }

            function imagePacket(data)
            {
                var addedElement = null;

                if (data.imagePath != null)
                {
                    addedElement = document.createElement('img');

                    var imageType = "data:image/png";
                    if (data.imagePath.endsWith("gif"))
                    {
                        imageType = "data:image/gif";
                    }
                    else if (data.imagePath.endsWith("jpg"))
                    {
                        imageType = "data:image/jpg";
                    }
                    else if (data.imagePath.endsWith("jpeg"))
                    {
                        imageType = "data:image/jpeg";
                    }

                    addedElement.src = imageType + ";base64," + data.imageData;

                    addedElement.style.cssText += 'width: ' + data.width + 'px; height: ' + data.height + 'px; ';

                    addWaitRemoveElement(data, addedElement);
                }
            }

            function textPacket(data)
            {
                var addedElement = null;

                if (data.text != null)
                {
                    addedElement = document.createElement('h1');
                    addedElement.innerHTML = data.text;
                    addedElement.style.cssText += 'font-size: ' + data.fontSize + 'px; color: ' + data.color + '; ' +
                        'text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black;';
                }

                addWaitRemoveElement(data, addedElement);
            }

            function htmlTextPacket(data)
            {
                var addedElement = null;

                if (data.htmlText != null)
                {
                    addedElement = document.createElement('div');
                    addedElement.innerHTML = data.htmlText;
                }

                addWaitRemoveElement(data, addedElement);
            }
			
			function rouletteWheelPacket(data)
            {
                if (roluetteWheelDiv != null)
                {
                    roluetteWheelDiv.style.visibility = 'visible';
                    theWheel.animation.spins = 8;
                    theWheel.startAnimation();
                }
			}

			function addWaitRemoveElement(data, addedElement)
			{
				if (addedElement != null)
				{
					addedElement.style.cssText += 'position: absolute; left: ' + data.horizontal.toString() + '%; top: ' +
						data.vertical.toString() + '%; transform: translate(-50%, -50%);'

					mainOverlayDiv.appendChild(addedElement);

					setTimeout(function ()
					{
						mainOverlayDiv.removeChild(addedElement);
					}, data.duration * 1000);
				}
            }
			
			function rouletteWheelResult()
            {
                setTimeout(function () {

                    if (roluetteWheelDiv != null) {
                        roluetteWheelDiv.style.visibility = 'hidden';

                        var winningSegment = theWheel.getIndicatedSegment();

                        theWheel.stopAnimation(false);
                        theWheel.rotationAngle = 0;
                        theWheel.draw();

                        if (winningSegment != null && winningSegment.text != null) {
                            sendPacket('rouletteWheelResult', winningSegment.text);
                        }
                    }

                }, 3000);
            }

            function logException(err)
            {
                if (isDebug)
                {
                    var addedElement = document.createElement('h1');
                    addedElement.innerHTML = err.toString();
                    addedElement.style.cssText += 'font-size: 100px';

                    var data = { horizontal: 50, vertical: 50, duration: 10 };

                    addWaitRemoveElement(data, addedElement);
                }
                logToSessionStorage(err);
            }

            openWebsocketConnection("8111");
		</script>
    </body>
</html>